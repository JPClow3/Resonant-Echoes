
<script type="importmap">
{
  "imports": {
    "react/": "https://esm.sh/react@^19.1.0/",
    "react": "https://esm.sh/react@^19.1.0",
    "react-dom/": "https://esm.sh/react-dom@^19.1.0/",
    "@google/genai": "https://esm.sh/@google/genai@^1.6.0"
  }
}
</script>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fantasy Quest AI - Resonant Echoes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=EB+Garamond:ital,wght@0,400..800;1,400..800&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Font Definitions (Unchanged) */
      --font-body: 'EB Garamond', serif;
      --font-heading: 'MedievalSharp', cursive;

      /* Light Mode: "Crystalline Veil" */
      --background-primary-light: #F0F4FF; /* Very pale ethereal blue */
      --background-secondary-light: #E2E9FE; /* Slightly more saturated pale blue */
      --text-main-light: #3A3F78; /* Deep indigo/blue-purple */
      --text-heading-light: #5A60C8; /* Brighter blue-purple */
      --text-muted-light: #8088C0; /* Muted blue-purple */
      --accent-primary-light: #7B8AFF; /* Bright, light ethereal blue */
      --accent-secondary-light: #AAB4FF; /* Paler bright ethereal blue */
      --button-primary-bg-light: linear-gradient(180deg, #8A9AFF, #707CFF); /* Ethereal blue gradient */
      --button-secondary-bg-light: linear-gradient(180deg, #B0B8FF, #909AFF); /* Lighter ethereal blue gradient */
      --button-text-light: #FFFFFF; /* White for good contrast on blue buttons */
      --button-choice-border-light: var(--accent-primary-light);
      --button-choice-hover-bg-light: var(--accent-primary-light);
      --button-choice-hover-text-light: #FFFFFF;
      
      --magical-positive-color-light: #A0FFF0; /* Very light, energetic cyan */
      --magical-positive-border-light: #50C8B0; /* Darker cyan */
      --magical-echo-hint-color-light: #90B0FF; /* Soft ethereal sky blue */
      --magical-echo-hint-border-light: #6080DF; /* Darker ethereal sky blue */
      --magical-dissonance-color-light: #A050D0; /* Medium-deep violet */
      --magical-dissonance-border-light: #7030A0; /* Darker violet */
      
      --magical-error-text-light: #FF4060; /* Luminous red/pink for errors */
      --lore-keyword-text-light: #6070D0; /* Muted mystical blue-violet */
      --lore-keyword-tooltip-bg-light: var(--background-secondary-light);
      --lore-keyword-tooltip-text-light: var(--text-main-light);
      --scrollbar-thumb-light: var(--accent-secondary-light);
      --scrollbar-track-light: var(--background-primary-light);
      --divider-light: color-mix(in srgb, var(--accent-primary-light) 60%, var(--background-secondary-light) 40%);

      /* Dark Mode: "Astral Weave" */
      --background-primary-dark: #1A1238; /* Deep violet-blue, like a nebula */
      --background-secondary-dark: #251A4A; /* Slightly lighter deep violet-blue */
      --text-main-dark: #D8E0FF; /* Pale luminous blue-lavender */
      --text-heading-dark: #EAF2FF; /* Brighter pale luminous blue-lavender */
      --text-muted-dark: #8A98C8; /* Muted cool blue-grey */
      --accent-primary-dark: #9080FF; /* Luminous violet */
      --accent-secondary-dark: #7860E0; /* Deeper luminous violet */
      --button-primary-bg-dark: linear-gradient(180deg, #8070F0, #6050D0); /* Luminous violet gradient */
      --button-secondary-bg-dark: linear-gradient(180deg, #5040A0, #403080); /* Deeper violet gradient */
      --button-text-dark: var(--text-heading-dark);
      --button-choice-border-dark: var(--accent-primary-dark);
      --button-choice-hover-bg-dark: var(--accent-primary-dark);
      --button-choice-hover-text-dark: #FFFFFF;

      --magical-positive-color-dark: #90FFFF; /* Very bright, energetic cyan */
      --magical-positive-border-dark: #60C0F0; /* Medium-bright cyan */
      --magical-echo-hint-color-dark: #B0D0FF; /* Pale luminous blue */
      --magical-echo-hint-border-dark: #80A0E0; /* Medium pale luminous blue */
      --magical-dissonance-color-dark: #D060FF; /* Bright, energetic violet/magenta */
      --magical-dissonance-border-dark: #A030D0; /* Deep energetic violet/magenta */

      --magical-error-text-dark: #FF5080; /* Bright pink/magenta for errors on dark */
      --lore-keyword-text-dark: #B0C8FF; /* Light glowing blue */
      --lore-keyword-tooltip-bg-dark: var(--background-secondary-dark);
      --lore-keyword-tooltip-text-dark: var(--text-main-dark);
      --scrollbar-thumb-dark: var(--accent-secondary-dark);
      --scrollbar-track-dark: var(--background-primary-dark);
      --divider-dark: color-mix(in srgb, var(--accent-primary-dark) 50%, var(--background-secondary-dark) 50%);
      
      /* Default to Light Mode variables */
      --background-primary: var(--background-primary-light);
      --background-secondary: var(--background-secondary-light);
      --text-main: var(--text-main-light);
      --text-heading: var(--text-heading-light);
      --text-muted: var(--text-muted-light);
      --accent-primary: var(--accent-primary-light);
      --accent-secondary: var(--accent-secondary-light);
      --button-primary-bg: var(--button-primary-bg-light);
      --button-secondary-bg: var(--button-secondary-bg-light);
      --button-text: var(--button-text-light);
      --button-choice-border: var(--button-choice-border-light);
      --button-choice-hover-bg: var(--button-choice-hover-bg-light);
      --button-choice-hover-text: var(--button-choice-hover-text-light);
      
      --magical-positive-color: var(--magical-positive-color-light);
      --magical-positive-border: var(--magical-positive-border-light);
      --magical-echo-hint-color: var(--magical-echo-hint-color-light);
      --magical-echo-hint-border: var(--magical-echo-hint-border-light);
      --magical-dissonance-color: var(--magical-dissonance-color-light);
      --magical-dissonance-border: var(--magical-dissonance-border-light);

      --magical-error-text: var(--magical-error-text-light);
      --lore-keyword-text: var(--lore-keyword-text-light);
      --lore-keyword-tooltip-bg: var(--lore-keyword-tooltip-bg-light);
      --lore-keyword-tooltip-text: var(--lore-keyword-tooltip-text-light);
      --scrollbar-thumb: var(--scrollbar-thumb-light);
      --scrollbar-track: var(--scrollbar-track-light);
      --echo-pulse-color: var(--magical-echo-hint-color-light); 
      --divider-color: var(--divider-light);

      /* Color-Blind Assist Mode Variables (Adjusted for new base themes) */
      --cb-text-main-light: #202040; /* Very dark blue-purple for high contrast */
      --cb-accent-primary-light: #575EA6; /* Darker, less saturated version of new light accent */
      --cb-magical-positive-bg-light: #E8EAF6; /* Very pale indigo/blue */
      --cb-magical-positive-border-light: #000000; /* Black for max contrast */
      --cb-magical-echo-hint-bg-light: #DDE2F0; /* Slightly darker pale indigo/blue */
      --cb-magical-echo-hint-border-light: #000000; /* Black */
      --cb-magical-dissonance-bg-light: #39305A; /* Dark violet-blue for white text */
      --cb-magical-dissonance-border-light: #000000; /* Black */
      --cb-lore-keyword-text-light: var(--cb-text-main-light);

      --cb-text-main-dark: #F0F8FF; /* Alice blue (almost white) for high contrast */
      --cb-accent-primary-dark: #B5AEF5; /* Lighter, less saturated version of new dark accent */
      --cb-magical-positive-bg-dark: #D8DAEF; /* Light lavender-blue for black text */
      --cb-magical-positive-border-dark: #FFFFFF; /* White for max contrast */
      --cb-magical-echo-hint-bg-dark: #C5C8E6; /* Medium lavender-blue */
      --cb-magical-echo-hint-border-dark: #FFFFFF; /* White */
      --cb-magical-dissonance-bg-dark: #8088C0; /* Medium blue-purple for white text */
      --cb-magical-dissonance-border-dark: #FFFFFF; /* White */
      --cb-lore-keyword-text-dark: var(--cb-text-main-dark);
    }

    html.theme-dark { /* Applied by JS */
      --background-primary: var(--background-primary-dark);
      --background-secondary: var(--background-secondary-dark);
      --text-main: var(--text-main-dark);
      --text-heading: var(--text-heading-dark);
      --text-muted: var(--text-muted-dark);
      --accent-primary: var(--accent-primary-dark);
      --accent-secondary: var(--accent-secondary-dark);
      --button-primary-bg: var(--button-primary-bg-dark);
      --button-secondary-bg: var(--button-secondary-bg-dark);
      --button-text: var(--button-text-dark);
      --button-choice-border: var(--button-choice-border-dark);
      --button-choice-hover-bg: var(--button-choice-hover-bg-dark);
      --button-choice-hover-text: var(--button-choice-hover-text-dark);
      
      --magical-positive-color: var(--magical-positive-color-dark);
      --magical-positive-border: var(--magical-positive-border-dark);
      --magical-echo-hint-color: var(--magical-echo-hint-color-dark);
      --magical-echo-hint-border: var(--magical-echo-hint-border-dark);
      --magical-dissonance-color: var(--magical-dissonance-color-dark);
      --magical-dissonance-border: var(--magical-dissonance-border-dark);

      --magical-error-text: var(--magical-error-text-dark);
      --lore-keyword-text: var(--lore-keyword-text-dark);
      --lore-keyword-tooltip-bg: var(--lore-keyword-tooltip-bg-dark);
      --lore-keyword-tooltip-text: var(--lore-keyword-tooltip-text-dark);
      --scrollbar-thumb: var(--scrollbar-thumb-dark);
      --scrollbar-track: var(--background-primary-dark);
      --echo-pulse-color: var(--magical-echo-hint-color-dark);
      --divider-color: var(--divider-dark);
    }

    /* Color-Blind Assist Mode Active - Light Theme */
    html.cb-assist-active {
      --text-main: var(--cb-text-main-light);
      --text-heading: var(--cb-text-main-light); 
      --text-muted: color-mix(in srgb, var(--cb-text-main-light) 70%, var(--background-primary-light) 30%);
      --accent-primary: var(--cb-accent-primary-light);
      
      --magical-positive-color: var(--cb-text-main-light); 
      --magical-positive-bg: var(--cb-magical-positive-bg-light); 
      --magical-positive-border: var(--cb-magical-positive-border-light);

      --magical-echo-hint-color: var(--cb-text-main-light);
      --magical-echo-hint-bg: var(--cb-magical-echo-hint-bg-light);
      --magical-echo-hint-border: var(--cb-magical-echo-hint-border-light);

      --magical-dissonance-color: #FFFFFF; 
      --magical-dissonance-bg: var(--cb-magical-dissonance-bg-light);
      --magical-dissonance-border: var(--cb-magical-dissonance-border-light);

      --lore-keyword-text: var(--cb-lore-keyword-text-light);
      --lore-keyword-tooltip-bg: var(--background-secondary-light);
      --lore-keyword-tooltip-text: var(--cb-text-main-light);
    }

    /* Color-Blind Assist Mode Active - Dark Theme */
    html.cb-assist-active.theme-dark {
      --text-main: var(--cb-text-main-dark);
      --text-heading: var(--cb-text-main-dark);
      --text-muted: color-mix(in srgb, var(--cb-text-main-dark) 70%, var(--background-primary-dark) 30%);
      --accent-primary: var(--cb-accent-primary-dark);

      --magical-positive-color: #000000; 
      --magical-positive-bg: var(--cb-magical-positive-bg-dark);
      --magical-positive-border: var(--cb-magical-positive-border-dark);

      --magical-echo-hint-color: #000000;
      --magical-echo-hint-bg: var(--cb-magical-echo-hint-bg-dark);
      --magical-echo-hint-border: var(--cb-magical-echo-hint-border-dark);

      --magical-dissonance-color: #FFFFFF; 
      --magical-dissonance-bg: var(--cb-magical-dissonance-bg-dark);
      --magical-dissonance-border: var(--cb-magical-dissonance-border-dark);
      
      --lore-keyword-text: var(--cb-lore-keyword-text-dark);
      --lore-keyword-tooltip-bg: var(--background-secondary-dark);
      --lore-keyword-tooltip-text: var(--cb-text-main-dark);
    }


    body {
      font-family: var(--font-body);
      background-color: var(--background-primary);
      color: var(--text-main);
      transition: background-color 0.3s ease, color 0.3s ease;
      margin: 0;
    }
    .font-body { font-family: var(--font-body); }
    .font-heading { font-family: var(--font-heading); }

    /* Utility Theme Classes */
    .bg-primary { background-color: var(--background-primary); }
    .bg-secondary { background-color: var(--background-secondary); }
    .text-main-color { color: var(--text-main); }
    .text-heading-color { color: var(--text-heading); }
    .text-muted-color { color: var(--text-muted); }
    .accent-text-color { color: var(--accent-primary); }
    .accent-bg-color { background-color: var(--accent-primary); }
    .error-text-color { color: var(--magical-error-text); }
    .divider-border-color { border-color: var(--divider-color); }
    .divider-border { border: 1px solid var(--divider-color); }
    .divider-border-b { border-bottom: 1px solid var(--divider-color); }
    .divider-border-l { border-left: 2px solid var(--divider-color); }
    .accent-border-l-4 { border-left-width: 4px; border-left-style: solid; border-left-color: var(--accent-primary); }
    .error-border-l-4 { border-left-width: 4px; border-left-style: solid; border-left-color: var(--magical-error-text); }


    /* Custom Animations */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .animate-fadeIn { animation: fadeIn 0.7s ease-in-out; }

    @keyframes fadeInUp-story {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeInUp-story { animation: fadeInUp-story 0.5s ease-out forwards; }


    @keyframes subtleParchmentPulse { 
      0%, 100% { background-position: 0% 50%; filter: brightness(1); }
      50% { background-position: 100% 50%; filter: brightness(1.02); }
    }
    .fantasy-parchment { /* This class is now a misnomer, but the animation effect is a subtle shimmer which is still nice */
      animation: subtleParchmentPulse 45s ease-in-out infinite;
    }
    
    @keyframes home-title-reveal {
      0% { opacity: 0; transform: translateY(-20px); letter-spacing: 0.2em; text-shadow: 0 0 15px var(--accent-primary-light); }
      80% { opacity: 0.8; letter-spacing: 0.05em; text-shadow: 0 0 8px var(--accent-primary-light); }
      100% { opacity: 1; transform: translateY(0); letter-spacing: normal; text-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    }
    html.theme-dark .home-title-reveal {
       0% { text-shadow: 0 0 15px var(--accent-primary-dark); }
       80% { text-shadow: 0 0 8px var(--accent-primary-dark); }
    }
    .home-title-reveal { animation: home-title-reveal 1.5s ease-out forwards; }

    @keyframes echoicUnveil {
      0% { opacity: 0; letter-spacing: 0.25em; transform: translateY(-10px); filter: blur(3px) brightness(1.5); color: var(--accent-primary); }
      70% { opacity: 0.7; letter-spacing: 0.05em; filter: blur(0.5px) brightness(1.2); color: color-mix(in srgb, var(--accent-primary) 70%, var(--text-heading) 30%); }
      100% { opacity: 1; letter-spacing: normal; transform: translateY(0); filter: blur(0px) brightness(1); color: var(--text-heading); }
    }
    .echoic-unveil-title {
      animation: echoicUnveil 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }

    @keyframes subtleBreathing {
      0%, 100% { transform: scale(1); opacity: 1; filter: brightness(1); }
      50% { transform: scale(1.002); opacity: 0.99; filter: brightness(1.01); }
    }
    .subtle-breathing-panel {
      animation: subtleBreathing 10s infinite ease-in-out;
    }

    @keyframes activeFeedbackPulse { 
      0% {
        transform: scale(1);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 0 0 0px color-mix(in srgb, var(--accent-primary) 30%, transparent);
      }
      50% {
        transform: scale(0.97);
        filter: brightness(1.1); /* Increased brightness */
        box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 0 0 10px color-mix(in srgb, var(--accent-primary) 25%, transparent), 0 0 5px var(--accent-primary); /* Added inner glow */
      }
      100% {
        transform: scale(1);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 0 0 15px color-mix(in srgb, var(--accent-primary) 0%, transparent);
      }
    }
    
    @keyframes gentlePulse {
      0%, 100% { opacity: 1; transform: scale(1); filter: brightness(1); }
      50% { opacity: 0.85; transform: scale(1.02); filter: brightness(1.1); }
    }
    .animate-gentle-pulse { animation: gentlePulse 2s infinite ease-in-out; }

    .new-entry-glow-button {
      animation: gentlePulse 1.8s infinite ease-in-out;
      box-shadow: 0 0 10px var(--magical-positive-color), 0 0 6px var(--magical-positive-color), 0 0 3px var(--background-primary); /* Inner glow too */
    }
     html.cb-assist-active .new-entry-glow-button {
        box-shadow: 0 0 8px var(--magical-positive-border), 0 0 4px var(--magical-positive-border);
     }
    
    @keyframes simplePulse { 
      0%, 100% { opacity: 1; filter: brightness(1); }
      50% { opacity: 0.85; filter: brightness(1.05); }
    }
    .animate-simple-pulse { animation: simplePulse 2s infinite ease-in-out; }


    @keyframes chosen-button-feedback {
      0% { opacity: 1; transform: scale(1); }
      30% { border-color: var(--magical-positive-color); box-shadow: 0 0 12px var(--magical-positive-color), 0 0 5px var(--magical-positive-color); transform: scale(1.02); filter: brightness(1.1); }
      70% { opacity: 0.8; transform: scale(0.99); filter: brightness(1.2); }
      100% { opacity: 1; transform: scale(1); filter: brightness(1); border-color: var(--button-choice-border); box-shadow: none; }
    }
    html.cb-assist-active .chosen-button-feedback {
       30% { border-color: var(--magical-positive-border); box-shadow: 0 0 10px var(--magical-positive-border); }
    }
    .chosen-button-feedback { animation: chosen-button-feedback 0.7s ease-out; }

    @keyframes subtleShine {
      0% { filter: brightness(1); }
      50% { filter: brightness(1.3) saturate(1.3); text-shadow: 0 0 8px var(--magical-positive-color), 0 0 4px var(--magical-positive-color); }
      100% { filter: brightness(1); }
    }
    html.cb-assist-active .animate-subtle-shine {
        50% { filter: brightness(1.15); text-shadow: 0 0 3px var(--magical-positive-border); }
    }
    .animate-subtle-shine { animation: subtleShine 0.8s ease-out; }

    @keyframes itemEntryAnimate {
      from { opacity: 0; transform: scale(0.8) translateY(5px); filter: blur(2px); }
      to { opacity: 1; transform: scale(1) translateY(0); filter: blur(0px); }
    }
    .item-entry-animate { animation: itemEntryAnimate 0.4s ease-out forwards; }

    /* Scrollbar styling */
    .custom-scrollbar::-webkit-scrollbar { width: 10px; height: 10px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: var(--scrollbar-track); border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 10px; border: 2px solid var(--scrollbar-track); }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { filter: brightness(1.2); }
    .custom-scrollbar { scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track); }


    /* General Button Style */
    .fantasy-button {
      font-family: var(--font-heading);
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px color-mix(in srgb, var(--text-main) 10%, transparent), 0 0 10px color-mix(in srgb, var(--accent-primary) 5%, transparent);
      transition: all 0.2s ease-in-out;
      cursor: pointer;
      text-align: center;
      border: none; 
    }
    .fantasy-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(60%) brightness(0.8);
    }
    .fantasy-button:not(:disabled):active {
      animation: activeFeedbackPulse 0.35s ease-out forwards;
    }
     .fantasy-button:not(:disabled):hover, .fantasy-button:not(:disabled):focus-visible {
      filter: brightness(1.15);
      transform: translateY(-1px) scale(1.01);
      box-shadow: 0 4px 8px color-mix(in srgb, var(--text-main) 15%, transparent), 0 0 15px color-mix(in srgb, var(--accent-primary) 10%, transparent);
    }
     .fantasy-button:focus-visible {
        outline: 2px solid var(--accent-primary);
        outline-offset: 2px;
     }


    .fantasy-button-primary {
      background: var(--button-primary-bg);
      color: var(--button-text);
      text-shadow: 1px 1px 2px color-mix(in srgb, var(--text-main) 30%, transparent);
    }
     html.cb-assist-active .fantasy-button-primary {
        background: var(--cb-accent-primary-light); 
        color: var(--background-primary-light); /* Light text on darker CB accent */
        text-shadow: 1px 1px 1px #00000066;
     }
     html.cb-assist-active.theme-dark .fantasy-button-primary {
        background: var(--cb-accent-primary-dark);
        color: var(--background-primary-dark); /* Dark text on lighter CB accent */
        text-shadow: 1px 1px 1px #ffffff33;
     }


    .fantasy-button-secondary {
      background: var(--button-secondary-bg);
      color: var(--button-text);
      text-shadow: 1px 1px 2px color-mix(in srgb, var(--text-main) 20%, transparent);
    }
    html.cb-assist-active .fantasy-button-secondary {
        background: var(--text-muted);
        color: var(--background-primary);
        border: 1px solid var(--text-main);
        text-shadow: 1px 1px 1px #00000044;
     }
     html.cb-assist-active.theme-dark .fantasy-button-secondary {
        background: var(--text-muted);
        color: var(--background-primary);
        border: 1px solid var(--text-main);
        text-shadow: 1px 1px 1px #ffffff22;
     }


    .fantasy-button-choice {
      font-family: var(--font-body); 
      padding: 0.75rem 1rem;
      border: 2px solid var(--button-choice-border);
      background-color: transparent;
      color: var(--text-main);
      border-radius: 0.5rem;
      text-align: left;
      transition: background-color 0.2s ease-out, color 0.2s ease-out, border-color 0.2s ease-out, transform 0.15s ease-out, box-shadow 0.15s ease-out, filter 0.2s ease-out, opacity 0.5s ease-out;
    }
    .fantasy-button-choice:not(:disabled):hover, .fantasy-button-choice:not(:disabled):focus-visible {
      background-color: var(--button-choice-hover-bg);
      color: var(--button-choice-hover-text);
      border-color: var(--button-choice-hover-bg); 
      transform: translateY(-2px);
      box-shadow: 0 3px 6px color-mix(in srgb, var(--text-main) 15%, transparent), 0 0 8px var(--accent-primary);
      filter: brightness(1.05);
    }
     .fantasy-button-choice:focus-visible {
        outline: 2px solid var(--accent-primary);
        outline-offset: 1px;
     }
    .choice-echo-weaving-hint:not(:disabled):hover, .choice-echo-weaving-hint:not(:disabled):focus-visible {
      box-shadow: 0 0 12px var(--magical-echo-hint-color), 0 0 8px var(--magical-echo-hint-color), 0 3px 6px color-mix(in srgb, var(--text-main) 15%, transparent);
      border-color: var(--magical-echo-hint-color);
      filter: brightness(1.1);
    }
    html.cb-assist-active .choice-echo-weaving-hint:not(:disabled):hover, 
    html.cb-assist-active .choice-echo-weaving-hint:not(:disabled):focus-visible {
      border: 2px dotted var(--magical-echo-hint-border);
      background-color: var(--magical-echo-hint-bg);
      color: var(--magical-echo-hint-color);
      box-shadow: 0 0 5px var(--magical-echo-hint-border);
    }

    /* New style for Echo Hotspot choices */
    .choice-echo-hotspot-hint:not(:disabled) {
        border-left-width: 5px;
        border-left-color: var(--magical-positive-color); /* Use a distinct color, positive for interaction */
    }
    .choice-echo-hotspot-hint:not(:disabled):hover, .choice-echo-hotspot-hint:not(:disabled):focus-visible {
      box-shadow: 0 0 12px var(--magical-positive-color), 0 0 8px var(--magical-positive-color), 0 3px 6px color-mix(in srgb, var(--text-main) 15%, transparent);
      border-color: var(--magical-positive-color);
      filter: brightness(1.15); /* Slightly more emphasis */
    }
     html.cb-assist-active .choice-echo-hotspot-hint:not(:disabled) {
        border-left-color: var(--cb-magical-positive-border-light);
     }
     html.cb-assist-active .choice-echo-hotspot-hint:not(:disabled):hover, 
     html.cb-assist-active .choice-echo-hotspot-hint:not(:disabled):focus-visible {
        border: 2px solid var(--cb-magical-positive-border-light);
        background-color: var(--cb-magical-positive-bg-light);
        color: var(--cb-text-main-light);
        box-shadow: 0 0 5px var(--cb-magical-positive-border-light);
    }
     html.cb-assist-active.theme-dark .choice-echo-hotspot-hint:not(:disabled) {
        border-left-color: var(--cb-magical-positive-border-dark);
     }
     html.cb-assist-active.theme-dark .choice-echo-hotspot-hint:not(:disabled):hover, 
     html.cb-assist-active.theme-dark .choice-echo-hotspot-hint:not(:disabled):focus-visible {
        border: 2px solid var(--cb-magical-positive-border-dark);
        background-color: var(--cb-magical-positive-bg-dark);
        color: #000000; /* For dark CB, positive bg is light, so text is dark */
        box-shadow: 0 0 5px var(--cb-magical-positive-border-dark);
    }

    
    /* Illuminated Letter Style */
    .illuminated-first-letter::first-letter {
      font-family: var(--font-heading);
      font-size: 2.8em; 
      color: var(--accent-primary);
      float: left;
      margin-right: 0.07em;
      margin-bottom: -0.1em; 
      line-height: 0.75; 
      padding-top: 0.1em;
      filter: drop-shadow(1px 1px 2px color-mix(in srgb, var(--text-main) 20%, transparent)) brightness(1.1);
    }
     details > summary.illuminated-first-letter::first-letter { 
        margin-bottom: 0; 
     }
    
    /* Tone styles */
    .tone-whisper { font-style: italic; opacity: 0.8; color: var(--text-muted); filter: brightness(0.95); }
    .tone-urgent { font-weight: bold; color: var(--magical-dissonance-color); border-bottom: 2px dashed var(--magical-dissonance-border); text-shadow: 0 0 3px var(--magical-dissonance-color); } 
    .tone-fearful { font-style: italic; color: var(--magical-dissonance-color); text-decoration: wavy underline var(--magical-dissonance-border); filter: brightness(1.1); } 
    .tone-joyful { color: var(--magical-positive-color); filter: brightness(1.15); border-bottom: 2px solid var(--magical-positive-border); text-shadow: 0 0 4px var(--magical-positive-color); } 
    .tone-solemn { font-style: italic; color: var(--text-muted); opacity: 0.9; }
    .tone-ancient { color: var(--text-muted); letter-spacing: 0.05em; filter: opacity(0.9) brightness(0.9); }
    .tone-warning { font-weight: bold; color: var(--magical-dissonance-color); text-transform: uppercase; letter-spacing: 0.05em; border: 2px solid var(--magical-dissonance-border); padding: 0.1em 0.2em; display: inline-block; background-color: color-mix(in srgb, var(--magical-dissonance-border) 10%, transparent); text-shadow: 0 0 2px var(--magical-dissonance-color); }
    .tone-hopeful { color: var(--magical-positive-color); font-weight: 500; filter: brightness(1.1); }
    .tone-somber { font-style: italic; color: var(--text-muted); filter: saturate(0.7) brightness(0.9); }
    .tone-mysterious { font-style: italic; color: var(--magical-dissonance-color); filter: opacity(0.9) brightness(1.05); border-bottom: 1px dotted var(--magical-dissonance-border); }

    html.cb-assist-active .tone-urgent { color: var(--magical-dissonance-color); border-bottom: 2px dashed var(--magical-dissonance-border); background-color: var(--magical-dissonance-bg); text-shadow: none; }
    html.cb-assist-active .tone-fearful { color: var(--magical-dissonance-color); text-decoration: wavy underline var(--magical-dissonance-border); background-color: var(--magical-dissonance-bg); text-shadow: none; }
    html.cb-assist-active .tone-joyful { color: var(--magical-positive-color); border-bottom: 2px solid var(--magical-positive-border); background-color: var(--magical-positive-bg); text-shadow: none; }
    html.cb-assist-active .tone-warning { color: var(--magical-dissonance-color); border: 2px solid var(--magical-dissonance-border); background-color: var(--magical-dissonance-bg); text-shadow: none; }
    html.cb-assist-active .tone-hopeful { color: var(--magical-positive-color); background-color: var(--magical-positive-bg); text-shadow: none; }
    html.cb-assist-active .tone-mysterious { color: var(--magical-dissonance-color); border-bottom: 1px dotted var(--magical-dissonance-border); background-color: var(--magical-dissonance-bg); text-shadow: none; }


    .lore-keyword {
      font-weight: 600; 
      color: var(--lore-keyword-text);
      cursor: help; 
      transition: color 0.2s ease-in-out, filter 0.2s ease-in-out, transform 0.2s ease-in-out, text-shadow 0.2s ease-in-out;
      position: relative; 
      border-bottom: 1px dotted color-mix(in srgb, var(--lore-keyword-text) 70%, transparent);
      padding-bottom: 1px;
      display: inline-block; 
    }
    .lore-keyword:hover, .lore-keyword:focus-visible {
      filter: brightness(1.25) saturate(1.2);
      border-bottom-style: solid;
      outline: none;
      transform: scale(1.03); 
      text-shadow: 0 0 5px color-mix(in srgb, var(--lore-keyword-text) 60%, transparent); 
    }
    html.cb-assist-active .lore-keyword {
        border-bottom: 2px solid var(--lore-keyword-text); 
        padding-bottom: 0;
    }
    html.cb-assist-active .lore-keyword:hover, html.cb-assist-active .lore-keyword:focus-visible {
        text-shadow: none;
        filter: brightness(1.1); 
    }

    .lore-keyword .tooltip-text {
      visibility: hidden;
      width: max-content;
      max-width: 250px;
      background-color: var(--lore-keyword-tooltip-bg);
      color: var(--lore-keyword-tooltip-text);
      text-align: left;
      border-radius: 6px;
      padding: 8px 12px;
      position: absolute;
      z-index: 10;
      bottom: 135%; 
      left: 50%;
      transform: translateX(-50%) translateY(5px); 
      opacity: 0;
      transition: opacity 0.3s ease, visibility 0s 0.3s, transform 0.3s ease; 
      font-family: var(--font-body);
      font-weight: normal;
      font-size: 0.875rem;
      line-height: 1.4;
      box-shadow: 0 3px 8px color-mix(in srgb, var(--text-main) 25%, transparent);
      border: 1px solid var(--divider-color);
    }
    .lore-keyword:hover .tooltip-text, .lore-keyword:focus-visible .tooltip-text {
      visibility: visible;
      opacity: 1;
      transform: translateX(-50%) translateY(0);
      transition-delay: 0s;
    }

    /* Modal Styling */
    .modal-content-area {
      border: 2px solid var(--divider-color);
      box-shadow: 0 10px 25px color-mix(in srgb, var(--text-main) 30%, transparent), 0 0 30px color-mix(in srgb, var(--accent-primary) 15%, transparent);
    }
    @keyframes fadeInModal { from { opacity: 0; transform: translateY(-20px) scale(0.95); filter: blur(3px); } to { opacity: 1; transform: translateY(0) scale(1); filter: blur(0px); } }
    @keyframes fadeOutModal { from { opacity: 1; transform: translateY(0) scale(1); filter: blur(0px); } to { opacity: 0; transform: translateY(20px) scale(0.95); filter: blur(3px); } }
    .modal-content-enter-active { animation: fadeInModal 0.3s ease-out forwards; }
    .modal-content-exit-active { animation: fadeOutModal 0.3s ease-in forwards; } 

    @keyframes modalTitleAnimation {
      0% { opacity:0; letter-spacing: 0.2em; transform: translateY(-10px); color: var(--accent-primary); }
      100% { opacity:1; letter-spacing: normal; transform: translateY(0); color: var(--text-heading); }
    }
    .modal-title-animate { animation: modalTitleAnimation 0.5s 0.2s ease-out forwards; }

    @keyframes logEntryAppearStaggered {
      from { opacity: 0; transform: translateX(-15px); filter: blur(1px); }
      to { opacity: 1; transform: translateX(0); filter: blur(0px); }
    }
    .log-entry-appear-staggered { animation: logEntryAppearStaggered 0.4s ease-out forwards; }
    
    /* Journal specific summary styling */
    details > summary { list-style: none; } 
    details > summary::-webkit-details-marker { display: none; } 
    details > summary::marker { display: none; } 
    details > summary { 
      padding: 0.5rem 0.75rem; 
      border-radius: 0.375rem; 
      background-color: var(--background-primary);
      transition: background-color 0.2s, filter 0.2s, box-shadow 0.2s;
      box-shadow: 0 1px 2px color-mix(in srgb, var(--text-main) 5%, transparent);
    }
    details > summary:hover, details > summary:focus-visible { 
        filter: brightness(1.05); 
        outline: 1px dotted var(--accent-primary); 
        outline-offset: 1px;
        box-shadow: 0 2px 4px color-mix(in srgb, var(--text-main) 10%, transparent), 0 0 5px var(--accent-primary);
    }
    html.theme-dark details > summary:hover, html.theme-dark details > summary:focus-visible { filter: brightness(1.15); }
    
    details[open] > summary { 
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
      border-bottom: 1px solid var(--divider-color);
      box-shadow: 0 1px 2px color-mix(in srgb, var(--text-main) 5%, transparent) inset;
    }
    details > div { 
      padding: 0.75rem;
      border-top: none; 
      background-color: color-mix(in srgb, var(--background-primary) 95%, var(--background-secondary) 5%);
    }

    .history-log-player-choice {
        color: var(--accent-primary);
        font-style: italic;
        filter: brightness(1.1);
    }
     html.cb-assist-active .history-log-player-choice {
        font-weight: bold; 
        filter: none;
     }
    
    .game-status-display { }
    .game-status-item { 
      display: flex;
      align-items: center;
      transition: color 0.2s ease, filter 0.2s ease; 
    }
     .game-status-item:hover {
        filter: brightness(1.1);
     }
    .inventory-status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.25rem;
    }
    .inventory-status-grid > div { 
        animation: itemEntryAnimate 0.5s ease-out forwards;
    }


    .range-slider-thumb::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: var(--accent-primary);
      cursor: pointer;
      border-radius: 50%;
      border: 2px solid var(--background-secondary);
      box-shadow: 0 0 5px color-mix(in srgb, var(--accent-primary) 50%, transparent);
      transition: background-color 0.2s ease, box-shadow 0.2s ease;
    }
    .range-slider-thumb::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: var(--accent-primary);
      cursor: pointer;
      border-radius: 50%;
      border: 2px solid var(--background-secondary);
      box-shadow: 0 0 5px color-mix(in srgb, var(--accent-primary) 50%, transparent);
       transition: background-color 0.2s ease, box-shadow 0.2s ease;
    }
    .range-slider-thumb:hover::-webkit-slider-thumb, .range-slider-thumb:focus-visible::-webkit-slider-thumb { background: var(--magical-positive-color); box-shadow: 0 0 8px var(--magical-positive-color); }
    .range-slider-thumb:hover::-moz-range-thumb, .range-slider-thumb:focus-visible::-moz-range-thumb { background: var(--magical-positive-color); box-shadow: 0 0 8px var(--magical-positive-color); }
    .range-slider-thumb:disabled::-webkit-slider-thumb { background: var(--text-muted); box-shadow: none; }
    .range-slider-thumb:disabled::-moz-range-thumb { background: var(--text-muted); box-shadow: none; }


    .echo-intensity-faint { border-left-color: var(--magical-echo-hint-border); opacity: 0.8; background-color: color-mix(in srgb, var(--magical-echo-hint-bg, var(--background-primary)) 80%, transparent 20%); color: var(--magical-echo-hint-color); border-left-style: dotted;}
    .echo-intensity-clear { border-left-color: var(--magical-echo-hint-border); background-color: color-mix(in srgb, var(--magical-echo-hint-bg, var(--background-primary)) 90%, transparent 10%); color: var(--magical-echo-hint-color); border-left-style: solid;}
    .echo-intensity-strong { border-left-color: var(--magical-positive-border); border-left-width: 4px; background-color: color-mix(in srgb, var(--magical-positive-bg, var(--background-primary)) 85%, transparent 15%); color: var(--magical-positive-color); border-left-style: solid; filter: brightness(1.05);}
    .echo-intensity-overwhelming { border-left-color: var(--magical-positive-border); border-left-width: 6px; animation: simplePulse 1.5s infinite; background-color: color-mix(in srgb, var(--magical-positive-bg, var(--background-primary)) 75%, transparent 25%); color: var(--magical-positive-color); border-left-style: solid; filter: brightness(1.1); box-shadow: 0 0 8px var(--magical-positive-color); }
    .echo-intensity-chaotic { border-left-color: var(--magical-dissonance-border); border-left-width: 4px; animation: simplePulse 1s infinite alternate; background-color: color-mix(in srgb, var(--magical-dissonance-bg, var(--background-primary)) 80%, transparent 20%); color: var(--magical-dissonance-color); border-left-style: dashed; filter: brightness(1.05); box-shadow: 0 0 6px var(--magical-dissonance-color); }

    .whispering-echo-item {
        transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, border-left-color 0.2s ease-out, background-color 0.2s ease-out, color 0.2s ease-out, filter 0.2s ease-out;
     }
    .whispering-echo-item:hover {
        transform: translateY(-2px) scale(1.01);
        box-shadow: 0 4px 10px color-mix(in srgb, var(--text-main) 10%, transparent), 0 0 8px var(--magical-echo-hint-border);
        border-left-color: var(--magical-positive-border) !important; 
        filter: brightness(1.1);
    }


    @keyframes synthesisPulseActive {
      0% { box-shadow: 0 0 5px var(--magical-echo-hint-border), 0 0 0px var(--magical-echo-hint-color); }
      50% { box-shadow: 0 0 15px var(--magical-echo-hint-border), 0 0 10px var(--magical-echo-hint-color); }
      100% { box-shadow: 0 0 5px var(--magical-echo-hint-border), 0 0 0px var(--magical-echo-hint-color); }
    }
    .synthesis-pulse-active {
        animation: synthesisPulseActive 1.5s infinite ease-in-out;
    }
    
    @keyframes synthesisButtonReadyPulse {
      0%, 100% {
        box-shadow: 0 0 8px 0px var(--magical-echo-hint-border), 0 2px 4px color-mix(in srgb, var(--text-main) 15%, transparent);
        transform: scale(1); filter: brightness(1);
      }
      50% {
        box-shadow: 0 0 15px 3px var(--magical-echo-hint-border), 0 0 10px var(--magical-echo-hint-color), 0 3px 6px color-mix(in srgb, var(--text-main) 20%, transparent);
        transform: scale(1.02); filter: brightness(1.1);
      }
    }
    .synthesis-button-ready-pulse:not(:disabled) {
      animation: synthesisButtonReadyPulse 2s infinite ease-in-out;
      border-color: var(--magical-echo-hint-border);
      color: var(--magical-echo-hint-color);
    }
     html.cb-assist-active .synthesis-button-ready-pulse:not(:disabled) {
        border-color: var(--cb-magical-echo-hint-border-light);
        background-color: var(--cb-magical-echo-hint-bg-light);
        color: var(--cb-magical-echo-hint-color);
        box-shadow: 0 0 5px var(--cb-magical-echo-hint-border-light);
     }
     html.cb-assist-active.theme-dark .synthesis-button-ready-pulse:not(:disabled) {
        border-color: var(--cb-magical-echo-hint-border-dark);
        background-color: var(--cb-magical-echo-hint-bg-dark);
        color: #000000;
        box-shadow: 0 0 5px var(--cb-magical-echo-hint-border-dark);
     }


    @keyframes resonanceSurgeReadyPulse {
      0%, 100% {
        box-shadow: 0 0 8px 0px var(--magical-positive-border), 0 2px 4px color-mix(in srgb, var(--text-main) 15%, transparent);
        transform: scale(1); filter: brightness(1.05);
      }
      50% {
        box-shadow: 0 0 18px 4px var(--magical-positive-border), 0 0 12px var(--magical-positive-color), 0 3px 6px color-mix(in srgb, var(--text-main) 20%, transparent);
        transform: scale(1.03); filter: brightness(1.2);
      }
    }
    .resonance-surge-ready-pulse:not(:disabled) {
      animation: resonanceSurgeReadyPulse 1.8s infinite ease-in-out;
      border-color: var(--magical-positive-border);
      color: var(--magical-positive-color);
    }
     html.cb-assist-active .resonance-surge-ready-pulse:not(:disabled) {
        border-color: var(--cb-magical-positive-border-light);
        background-color: var(--cb-magical-positive-bg-light);
        color: var(--cb-magical-positive-color);
        box-shadow: 0 0 5px var(--cb-magical-positive-border-light);
     }
     html.cb-assist-active.theme-dark .resonance-surge-ready-pulse:not(:disabled) {
        border-color: var(--cb-magical-positive-border-dark);
        background-color: var(--cb-magical-positive-bg-dark);
        color: #000000;
        box-shadow: 0 0 5px var(--cb-magical-positive-border-dark);
     }
     
    .loading-indicator-text {
        color: var(--text-heading);
        filter: brightness(1.1);
        text-shadow: 0 0 5px var(--accent-primary);
    }

    .fantasy-button-home {
      background: rgba(20, 10, 30, 0.55); /* Dark, semi-transparent violet-blue */
      border: 2px solid rgba(170, 180, 255, 0.5); /* #AAB4FF from light theme accent */
      color: #EAF2FF; /* text-heading-dark */
      text-shadow: 0 0 8px rgba(144, 128, 255, 0.8), 0 0 3px #fff; /* #9080FF from dark theme accent, with a white inner glow */
      box-shadow: 0 0 18px rgba(144, 128, 255, 0.25), inset 0 0 12px rgba(26, 18, 56, 0.7); /* Outer glow, inner shadow */
      backdrop-filter: blur(3px);
      font-family: var(--font-heading);
      transition: all 0.25s ease-out;
    }

    .fantasy-button-home:not(:disabled):hover, 
    .fantasy-button-home:not(:disabled):focus-visible {
      background: rgba(30, 18, 50, 0.7);
      border-color: rgba(220, 225, 255, 0.9);
      color: #ffffff;
      text-shadow: 0 0 10px rgba(170, 180, 255, 1), 0 0 5px #fff;
      box-shadow: 0 0 25px rgba(170, 180, 255, 0.5), inset 0 0 15px rgba(36, 28, 66, 0.8), 0 3px 6px rgba(0,0,0,0.3);
      transform: translateY(-2px) scale(1.02);
    }

    .fantasy-button-subtle { /* For less prominent actions like "Add Tag" */
      font-family: var(--font-body);
      padding: 0.5rem 0.75rem; /* Smaller padding */
      border-radius: 0.375rem; /* Smaller radius */
      box-shadow: 0 1px 2px color-mix(in srgb, var(--text-main) 8%, transparent);
      background: color-mix(in srgb, var(--background-primary) 50%, var(--background-secondary) 50%);
      color: var(--text-muted);
      border: 1px solid var(--divider-color);
      text-shadow: none;
    }
    .fantasy-button-subtle:not(:disabled):hover, .fantasy-button-subtle:not(:disabled):focus-visible {
      filter: brightness(1.05);
      transform: translateY(0px) scale(1.005);
      box-shadow: 0 1px 3px color-mix(in srgb, var(--text-main) 12%, transparent), 0 0 3px color-mix(in srgb, var(--accent-primary) 5%, transparent);
      color: var(--text-main);
      border-color: var(--accent-secondary);
    }
     html.theme-dark .fantasy-button-subtle:not(:disabled):hover, html.theme-dark .fantasy-button-subtle:not(:disabled):focus-visible {
      filter: brightness(1.15);
     }
    .fantasy-button-subtle:not(:disabled):active {
        animation: none; /* No grand pulse */
        transform: scale(0.98);
        filter: brightness(0.95);
    }

    /* Map Modal Styles */
    .map-container {
        background-image: radial-gradient(circle, var(--divider-color) 1px, transparent 1px);
        background-size: 20px 20px;
        background-color: var(--background-primary);
        position: relative;
        width: 100%;
        height: 100%;
        border: 2px solid var(--divider-color);
        border-radius: 0.5rem;
        overflow: hidden;
    }
    .map-location-dot {
        position: absolute;
        width: 12px;
        height: 12px;
        background-color: var(--accent-secondary);
        border-radius: 50%;
        border: 2px solid var(--background-primary);
        transform: translate(-50%, -50%);
        transition: transform 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
        z-index: 1;
    }
    .map-location-dot:hover {
        transform: translate(-50%, -50%) scale(1.8);
        background-color: var(--accent-primary);
        z-index: 2;
    }
    .map-location-dot.current-location {
        background-color: var(--magical-positive-color);
        box-shadow: 0 0 12px var(--magical-positive-color), 0 0 6px var(--magical-positive-color);
        animation: gentlePulse 1.5s infinite;
        z-index: 3;
    }
    .map-tooltip {
        visibility: hidden;
        opacity: 0;
        position: absolute;
        bottom: 150%;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--lore-keyword-tooltip-bg);
        color: var(--lore-keyword-tooltip-text);
        padding: 5px 10px;
        border-radius: 4px;
        font-family: var(--font-body);
        font-size: 0.9rem;
        white-space: nowrap;
        transition: opacity 0.2s, visibility 0.2s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .map-location-dot:hover .map-tooltip {
        visibility: visible;
        opacity: 1;
    }

    /* Echo Weaving Modal Styles */
    .echo-weaving-nexus {
        border: 3px dashed var(--magical-echo-hint-border);
        border-radius: 50%;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
        animation: synthesisPulseActive 2.5s infinite ease-in-out;
    }
    .echo-weaving-nexus.drop-active {
        background-color: color-mix(in srgb, var(--magical-echo-hint-bg, var(--background-secondary)) 50%, transparent);
        box-shadow: 0 0 20px var(--magical-echo-hint-color);
    }
    .echo-orb {
        cursor: grab;
        transition: transform 0.2s ease, opacity 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .echo-orb:active {
        cursor: grabbing;
        transform: scale(1.1);
        opacity: 0.8;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    /* Custom Action Input Style */
    .custom-action-input {
        border: 2px solid var(--magical-positive-border);
        box-shadow: 0 0 15px var(--magical-positive-color), inset 0 0 8px color-mix(in srgb, var(--magical-positive-color) 40%, transparent);
        animation: resonanceSurgeReadyPulse 2s infinite ease-in-out;
    }

  </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
  <noscript>You need to enable JavaScript to run this app.</noscript>
  <div id="root"></div>
  <script type="module" src="./index.tsx"></script>
<script type="module" src="/index.tsx"></script>
</body>
</html>